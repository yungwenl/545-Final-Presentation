---
title: "Untitled"
author: "Lulu Zhang"
date: "November 30, 2016"
output:
  word_document: default
  html_document: default
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Set up data and function Data backup building
```{r}
data=read.csv("MyLA311_Service_Request_Data_2016.csv")
#original_backup=data
library(dplyr)
library(ggplot2)
library(ggmap)
library(lubridate)
data$CreatedDate=mdy_hms(data$CreatedDate)
data$UpdatedDate=mdy_hms(data$UpdatedDate)
data$ProcessHours = round(difftime(data$UpdatedDate,data$CreatedDate,units = c("hours")),2)
data=backup
```

#2 graphs-Distribution of Services VS Processing Time Lacy Lulu
```{r}
data=backup
service_type = data %>%
  filter(Status !="Cancelled") %>%
  group_by(RequestType) %>%
  summarise(frequency= n())

process_time = data %>%
  filter(ActionTaken == "SR Created"& Status =="Closed") %>%
  group_by(RequestType)%>%
  summarise(avg = mean(ProcessHours))
  
service_type$top3 = service_type$frequency > 70000

p1 = ggplot(service_type,aes(x=reorder(RequestType, -frequency), y= frequency/1000, fill =service_type$top3)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(limits = c(0,540),
    labels = seq(0,540,100),
                     breaks = seq(0,540,100)) +
  ylab("Frequency") +
  geom_text(aes(label = frequency/1000), vjust = -0.2) +
  scale_fill_manual(values = c("cornflowerblue","indianred1"), guide =F)+
  theme(axis.text.x=element_text(angle = 30,vjust = 1, hjust=1))+
  xlab("")


lev =levels(process_time$RequestType)
lev=lev[c(1,5,8,7,3,2,12,6,10,9,11,4)]
process_time$RequestType=factor(process_time$RequestType, levels =lev)


 p2 =  ggplot(process_time,aes(x = RequestType, y = avg,group = 1))+
  geom_line() +
  geom_text(aes(label = as.integer(avg)),hjust =-0.6,vjust=0.9)+
  theme(axis.text.x=element_blank())+
  ylab("Average Processing Time (hours)")+
   xlab("") +
   geom_point(size =1)

library(gridExtra)
grid.arrange(p2,p1, nrow = 2,
             top = "Services Type Frequency(thousands) vs. Processing Time(hours)") 

```
#2 graphs-Department Frequency(thousands) vs. Processing Time(hours) Lacy
```{r}
data=backup

depart = data %>%
  filter(Status !="Cancelled" & Owner !="" & Owner !="BOE") %>%
  droplevels()%>%
  group_by(Owner) %>%
  summarise(count = n())

#unique(depart$Owner)

depart$top3 = depart$count > 20000

p3 = ggplot(data= depart,aes(x= reorder(Owner,-count), y =count/1000, fill = top3)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(limits = c(0,800),
                     labels = seq(0,800,100),
                     breaks = seq(0,800,100)) +
  xlab("") +
  ylab("Frequency") +
  geom_text(aes(label = count/1000), vjust = -0.2) +
  scale_fill_manual(values = c("cornflowerblue","indianred1"), guide =F)

data=backup
depart_time = data%>%
  filter(ActionTaken == "SR Created"& Status =="Closed" & Owner !="" & Owner !="BOE") %>%
  droplevels()%>%
  group_by(Owner)%>%
  summarise(avg = mean(ProcessHours))

depart_time$Owner=factor(depart_time$Owner, levels =c("BOS","OCB","BSL","ITA","BSS","LADWP"))


p4 = 
  ggplot(depart_time,aes(x = Owner, y = avg,group=1))+
  geom_line()+
  theme(axis.text.x=element_text())+
  geom_text(aes(label = as.integer(avg)),hjust =-0.6,vjust=0.9)+
  ylab("Average Processing Time (hours)")+
  xlab("")+
  geom_point(size=1,shape=3)


grid.arrange(p4,p3, nrow = 2,
             top = "Department Frequency(thousands) vs. Processing Time(hours)") 

```

#Request Source Frequency(Thousands) Bar Chart Lulu
```{r}
input_channel = data %>%
  filter(Status !="Cancelled") %>%
  group_by(RequestSource) %>%
  summarize(frequency = n())

ggplot(input_channel, aes(x= reorder(RequestSource, frequency/1000), y = frequency/1000))+
  geom_bar(stat = "identity") +
  coord_flip()+
  geom_text(aes(label=frequency),hjust = -0.1)+
  scale_y_continuous(limits = c(0,680),
                     labels = seq(0,680,100),
                     breaks = seq(0,680,100)) +
  xlab("")+
  ylab("Frequency")+
  ggtitle("Request Source (Thousands)")
```

#Summary - Service Type by Request Source Frequency(Thousands)" Summary Lulu
```{r}
data %>%
  filter(Status !="Cancelled") %>%
  group_by(RequestType, RequestSource) %>%
  summarize(frequency = n()) %>%
  ggplot(aes(x= RequestType,y= frequency)) +
  geom_bar(stat ="identity") +
  facet_wrap((~RequestSource))+
  xlab("Service Type")+
  ggtitle("Service Type by Request Source Summary")
```

#Service Type Frequency(Thousands) by Call  Lulu
```{r}
data %>%
  filter(RequestSource == "Call" & Status !="Cancelled") %>%
  group_by(RequestType) %>%
  summarize(frequency = n()) %>%
  ggplot(aes(x= reorder(RequestType,frequency/1000),y=frequency/1000)) +
  geom_bar(stat ="identity")+
  coord_flip()+
  ggtitle("Services Requested by Call(Thousands) ")+
  xlab("")+
  ylab("Frequency (Thousands)")
```

#Service Type Frequency(Thousands) by  Driver Self Report  Lulu
```{r}
data %>%
  filter(RequestSource == "Driver Self Report" & Status !="Cancelled") %>%
  group_by(RequestType) %>%
  summarize(frequency = n()) %>%
  ggplot(aes(x= reorder(RequestType,frequency/1000),y= frequency/1000)) +
  geom_bar(stat ="identity")+
  coord_flip()+
  ggtitle("Services Requested by Driver Self Report ")+
  xlab("Driver Self Report")+
  ylab("Frequency (Thousands)")
```

#Service Type Frequency(Thousands) by Mobile App Request  Lulu
```{r}
data %>%
  filter(RequestSource == "Mobile App" & Status !="Cancelled") %>%
  group_by(RequestType) %>%
  summarize(frequency = n()) %>%
  ggplot(aes(x= reorder(RequestType,frequency/1000),y= frequency/1000)) +
  geom_bar(stat ="identity")+
  coord_flip()+
  ggtitle("Services Requested by Mobile App")+
  xlab("Mobile App Request")+
  ylab("Frequency (Thousands)")
```

#Service Type Frequency(Thousands) by Self Service  Lulu
```{r}
data %>%
  filter(RequestSource == "Self Service" & Status !="Cancelled") %>%
  group_by(RequestType) %>%
  summarize(frequency = n()) %>%
  ggplot(aes(x= reorder(RequestType,frequency/1000),y= frequency/1000)) +
  geom_bar(stat ="identity")+
  coord_flip()+
  ggtitle("Services Requested by Self Service")+
  xlab("Self Service")+
  ylab("Frequency (Thousands)")
```

#Service Type Frequency(Thousands) by Email Request  Lulu
```{r}
data %>%
  filter(RequestSource == "Email" & Status !="Cancelled") %>%
  group_by(RequestType) %>%
  summarize(frequency = n()) %>%
  ggplot(aes(x= reorder(RequestType,frequency/1000),y= frequency/1000)) +
  geom_bar(stat ="identity")+
  coord_flip()+
  ggtitle("Services Requested by Email")+
  ylab("Frequency (Thousands)")+
  xlab("Email Request")
```

#TOP5 Seriveces by Top5 Input Channel(Fancy Bar) Lulu
```{r}
subset1 =data %>% 
   filter(RequestType %in% 
            c("Bulky Items",
              "Metal/Household Appliances",
              "Illegal Dumping Pickup",
              "Single Streetlight Issue",
              "Graffiti Removal") &
          RequestSource %in% 
            c("Call",
              "Email",
              "Driver Self Report",
              "Self Service",
              "Mobile App") &
          Status != "Cancelled") %>%
  group_by(RequestType,RequestSource) %>%
  summarize(frequency=n())

ggplot(subset1, aes(x= RequestType, y = frequency/1000, fill = RequestSource))+
  geom_bar(position = position_dodge(0.9), stat = "Identity") +
  theme(axis.text.x=element_text(angle = 15,vjust = 1, hjust=1))+
  ggtitle("Top5 Seriveces by Top5 Request Sources")+
  ylab("Frequency")+
  xlab("")
  #+theme_light()
```

#Summary-Service Type by Month Frequency Summary (Many LineGraphs) Lulu
```{r}
data=backup

subset2 = data %>%
  group_by(RequestType, month = month(CreatedDate, label = T)) %>%
  summarise(count = n())

ggplot(data = subset2, aes(x = month, y = count, group =1)) +
  geom_line(stat = "identity") +
  facet_wrap(~RequestType,nrow = 4)+
  ggtitle("All Service Types by Month (Frequency)")+
  ylab("Frequecy (Thousands)")
```

#Summary-Service Types by Month Frequency Summary (One LineGraph) Lulu
```{r}
subset2 %>%
ggplot(aes(x = month, y = count/1000, group = RequestType, col=RequestType)) +
  geom_line(stat = "identity") +
  ggtitle("All Services Request by Month")+
  ylab("Frequecy (Thousands)")
```

#Service Types by Month Frequency Summary without Bulky Items & Graffiti Removal (One LineGraph) Lulu
```{r}
subset2 %>%
  filter(RequestType != "Bulky Items" & RequestType != "Graffiti Removal") %>%
ggplot(aes(x = month, y = count, group = RequestType, col=RequestType)) +
  geom_line(stat = "identity") +
  ggtitle("Services Request by Month (no Bulky Items & Graffiti Removal)")
```

#Service Types by Month Frequency<2000 Summary (without Bulky Items ,Graffiti Removal,Illegal Dumping Pickup,Metal/Household Appliances) (One LineGraph) Lulu
```{r}
subset2 %>%
  filter(RequestType != "Bulky Items" & RequestType != "Graffiti Removal"& RequestType != "Illegal Dumping Pickup"& RequestType != "Metal/Household Appliances"& RequestType != "Electronic Waste"& RequestType != "Dead Animal Removal") %>%
ggplot(aes(x = month, y = count, group = RequestType, col=RequestType)) +
  geom_line(stat = "identity") +
  ggtitle("Services Request by Month (count <2200)")
```

#Bulky Items Request by Month (Frequency) Lulu
```{r}
subset2 %>%
  filter(RequestType =="Bulky Items") %>%
  ggplot(aes(x = month, y = count, group =1)) +
  geom_line(stat = "identity") +
  ggtitle("Bulky Items Service Request by Month")
```  

#Service Types by Month Frequency Summary (HeatMap) Lulu
```{r}
  ggplot(subset2, aes(x=month, y = RequestType, fill = count))+
  geom_tile() +
  scale_fill_gradient(low = "white", high = "darkgreen") +
  ylab("Service Type") +
  xlab("Month")

```

#Average Processing Hrs by RequestType (Bar) Lacy
```{r}
data=backup
data%>%
  filter(ActionTaken == "SR Created"& Status =="Closed") %>%
  group_by(RequestType)%>%
  summarise(avg = mean(ProcessHours))%>%
  ggplot(aes(x = reorder(RequestType,-avg), y = avg,fill= avg >200))+
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("lightblue","red"), guide =F)+
  geom_text(aes(label = as.integer(avg)),hjust =0.6)+
  theme(axis.text.x=element_text(angle = 45,vjust = 1, hjust=1))+
  ylab("Average Processing Time (hours)")+
  xlab("")+
  ggtitle("Average Processing Hours vs Service Type")
```

#Average processing Hrs by Owner(Department) (Bar) Lacy
```{r}
data=backup
data %>%
  filter(ActionTaken == "SR Created"& Status =="Closed") %>%
  group_by(Owner)%>%
  summarise(avg = mean(ProcessHours)) %>%
  ggplot(aes(x = reorder(Owner,-avg), y = avg))+
  geom_bar(stat = "identity")+
  #theme(axis.text.x=element_text(angle = 45,vjust = 1, hjust=1))+
  geom_text(aes(label = as.integer(avg)),hjust =0.6)+
  xlab("")+
  ylab("Average Processing Time (hours)")+
  ggtitle("Average Processing Hours vs Department")
```

#Overall call freqency (Map) Lacy
```{r}
LA = qmap("Los Angeles", zoom = 14, maptype = "roadmap", color="bw")
LA +
  stat_density2d(data = subset(data,data$Latitude != ""),
                 aes(x = Longitude, y = Latitude , fill = ..level..),
                 geom = "polygon", alpha = 0.2)+
  scale_fill_gradient(low = "white", high = "darkred" )+
  ggtitle("Calls Frequency Map")
```

#Successful Rate by Service Type (Point graph) Emily
```{r}
#unique(data$RequestType)

ServiceTypetotal=
  data %>%
  group_by(RequestType) %>%
  summarise(total=n())

ServiceType = data %>%
  filter(ActionTaken=="SR Created" & Status=="Closed") %>%
  group_by(RequestType)%>%
  summarise(count = n())%>%
  mutate(total=ServiceTypetotal$total)%>%
  mutate(DeliverRate= count/total*100)

ServiceType%>%
  ggplot(aes(x=DeliverRate, y= reorder(RequestType,DeliverRate)))+
  geom_point()+
  xlab("Successful Delivery Rate %")+
  ylab("Service Type")+
  ggtitle("Successful Rate break down by Service Type")

Feedback = data %>%
  filter(RequestType=="Feedback")
Other = data %>%
  filter(RequestType=="Other")

#str_locate(data$RequestType =="Feedback")
```

#Successful Rate by Department(Owner) (Point graph) Emily
```{r}
#unique(data$Owner)

Ownertotal=
  data %>%
  filter(Owner!="" & Owner!="BOE") %>%
  group_by(Owner) %>%
  summarise(total=n())

Owner = data %>%
  filter(ActionTaken=="SR Created" & Status=="Closed") %>%
  group_by(Owner)%>%
  summarise(deliver = n())%>%
  mutate(total=Ownertotal$total)%>%
  mutate(DeliverRate= deliver/total*100)

Owner%>%
  ggplot(aes(x=DeliverRate, y= reorder(Owner,DeliverRate)))+
  geom_point(color="indianred1", size=4)+
  xlab("Successful Delivery Rate %")+
  ylab("Department")+
  ggtitle("Successful Rate break down by Deparment")
 #+theme_light()
```

#Successful Rate by Request Source (Point graph) Emily
```{r}
RequestSourceTotal=
  data %>%
  #filter(RequestSource!="" & Owner!="BOE") %>%
  group_by(RequestSource) %>%
  summarise(total=n())%>%
  filter(total>17)

#unique(RequestSourceTotal)

RequestSource = data %>%
  filter(ActionTaken=="SR Created" & Status=="Closed") %>%
  group_by(RequestSource)%>%
  summarise(deliver = n())%>%
  filter(deliver>17)%>%
  mutate(total=RequestSourceTotal$total)%>%
  mutate(DeliverRate= deliver/total*100)

RequestSource%>%
  ggplot(aes(x=DeliverRate, y= reorder(RequestSource,DeliverRate)))+
  geom_point(color="blue", size=2)+
  xlab("Successful Delivery Rate %")+
  ylab("Request Source")+
  ggtitle("Successful Rate break down by Request Source")
```

#Lulu's Map (in process)
```{r}
data %>%
  filter(Status=="Cancelled"& RequestType=="Other") %>%
  ggplot(aes(x = Longitude, y = Latitude)) +
  geom_point() +
  geom_text(aes(label = RequestType), vjust = -1) +
  coord_map() 
```





